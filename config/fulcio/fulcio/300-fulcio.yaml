---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fulcio
  namespace: fulcio-system
---
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  namespace: fulcio-system
  name: fulcio
spec:
  template:
    metadata:
      annotations:
        autoscaling.knative.dev/min-scale: "1"
    spec:
      serviceAccountName: fulcio
      # This doesn't actually use Kubernetes credentials, so don't mount them in.
      automountServiceAccountToken: false
      containers:
      # DO NOT MERGE.
      # Just pulling a pre-built image instead of pulling it in, and then
      # having to customize iet, etc. in the tests.
      - image: gcr.io/priya-chainguard/fulcio-bd4d600f674b081a535a886a15cb8d9a@sha256:e182621aa741b8fd8c799d8a0cf90cc8dff5eb8ae809df379315c42457c22ae7
        name: fulcio
        ports:
        - containerPort: 8080
          name: h2c
        args:
          - "serve"
          - "--port=8080"
          - "--ca=fileca"
          - "--fileca-key"
          - "/var/run/fulcio-secrets/key.pem"
          - "--fileca-cert"
          - "/var/run/fulcio-secrets/cert.pem"
          - "--fileca-key-passwd"
          - "$(PASSWORD)"
          - "--ct-log-url=http://ctlog.ctlog-system.svc/sigstorescaffolding"
        env:
        - name: PASSWORD
          valueFrom:
            secretKeyRef:
              name: fulcio-secret
              key: password
        # Force a native go address resolution.
        - name: GODEBUG
          value: "netdns=go"
        volumeMounts:
        - name: fulcio-config
          mountPath: /etc/fulcio-config
        - name: oidc-info
          mountPath: /var/run/fulcio
        - name: fulcio-cert
          mountPath: "/var/run/fulcio-secrets"
          readOnly: true
      volumes:
      - name: fulcio-config
        configMap:
          name: fulcio-config
      - name: fulcio-cert
        secret:
          secretName: fulcio-secret
          items:
          - key: private
            path: key.pem
          - key: cert
            path: cert.pem
      - name: oidc-info
        projected:
          sources:
            - configMap:
                name: kube-root-ca.crt
                items:
                - key: ca.crt
                  path: ca.crt
                  mode: 0666

---
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  namespace: fulcio-system
  name: fulcio-grpc
spec:
  template:
    metadata:
      annotations:
        autoscaling.knative.dev/min-scale: "1"
    spec:
      serviceAccountName: fulcio
      # This doesn't actually use Kubernetes credentials, so don't mount them in.
      automountServiceAccountToken: false
      containers:
      - image: gcr.io/projectsigstore/fulcio@sha256:27c6e4fe64a72a537c133452d9c8e0518944d1d69aeee5e7ef8a9fbe70b8b5d3 # v1.0.0
        name: fulcio-grpc
        ports:
        - containerPort: 5554
        args:
          - "serve"
          - "--grpc-port=5554"
          - "--ca=fileca"
          - "--fileca-key"
          - "/var/run/fulcio-secrets/key.pem"
          - "--fileca-cert"
          - "/var/run/fulcio-secrets/cert.pem"
          - "--fileca-key-passwd"
          - "$(PASSWORD)"
          - "--ct-log-url=http://ctlog.ctlog-system.svc/sigstorescaffolding"
        env:
        - name: PASSWORD
          valueFrom:
            secretKeyRef:
              name: fulcio-secret
              key: password
        # Force a native go address resolution.
        - name: GODEBUG
          value: "netdns=go"
        volumeMounts:
        - name: fulcio-config
          mountPath: /etc/fulcio-config
        - name: oidc-info
          mountPath: /var/run/fulcio
        - name: fulcio-cert
          mountPath: "/var/run/fulcio-secrets"
          readOnly: true
      volumes:
      - name: fulcio-config
        configMap:
          name: fulcio-config
      - name: fulcio-cert
        secret:
          secretName: fulcio-secret
          items:
          - key: private
            path: key.pem
          - key: cert
            path: cert.pem
      - name: oidc-info
        projected:
          sources:
            - configMap:
                name: kube-root-ca.crt
                items:
                - key: ca.crt
                  path: ca.crt
                  mode: 0666
